```C++
#include <bits/stdc++.h>//源自CSES/Tree Algorithms/Company Queries ||
using namespace std;
 
int main(){
    ios::sync_with_stdio(0);
    cin.tie(0);
    cout.tie(0);
    int n,q;
    cin>>n>>q;
    vector<int> fa(n+1,0);
    for(int i=2;i<=n;i++){
        cin>>fa[i];
    }
    int num=0;
    vector<int> depth(n+1,0);
    for(int i=2;i<=n;i++){
        depth[i]=depth[fa[i]]+1;
    }
    while((1<<num)<=n) num++;
    vector<vector<int>> d(n+1,vector<int>(num,0));
    for(int i=1;i<=n;i++){
        d[i][0]=fa[i];
    }
    for(int i=1;i<num;i++){
        for(int j=1;j<=n;j++){
            if(d[j][i-1]==0){
                d[j][i]=0;
            }else{
                d[j][i]=d[d[j][i-1]][i-1];
            }
        }
    }
    while(q--){
        int a,b;
        cin>>a>>b;
        if(depth[a]<depth[b]){
            swap(a,b);
        }
        int diff=depth[a]-depth[b];
        for(int i=0;i<num;i++){
            if(diff&(1<<i)){
                a=d[a][i];
            }
        }
        if(a==b){
            cout<<a<<'\n';
            continue;
        }
        for(int i=num-1;i>=0;i--){
            if(d[a][i]!=d[b][i]){
                a=d[a][i];
                b=d[b][i];
            }
        }
        cout<<d[a][0]<<'\n';
    }
    return 0;
}
```
